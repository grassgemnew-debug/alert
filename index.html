<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>加密貨幣即時換倉提示 (修復版)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f9f9f9; }
        h1 { text-align: center; color: #333; }
        #instructions { max-width: 800px; margin: 20px auto; padding: 10px; background: #e0f7fa; border-radius: 5px; }
        #alert { background-color: #ffcccc; padding: 15px; font-size: 18px; text-align: center; display: none; border: 2px solid #ff5555; border-radius: 5px; }
        #error { background-color: #ffffcc; padding: 10px; font-size: 14px; text-align: center; display: none; border: 1px solid #ffaa00; border-radius: 5px; }
        #prices { margin: 20px 0; }
        table { border-collapse: collapse; width: 80%; margin: auto; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background-color: #4CAF50; color: white; }
        .highlight { background-color: #ff5555; color: white; }
        canvas { max-width: 800px; margin: 20px auto; }
        #lastUpdate { text-align: center; font-size: 14px; color: #555; }
        #refresh { display: block; margin: 10px auto; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #refresh:hover { background: #45a049; }
    </style>
</head>
<body>
    <h1>加密貨幣即時換倉提示 (BTC/ETH/SOL/SUI/LTC)</h1>
    <div id="instructions">
        <p><b>使用說明</b>：每 10 分鐘檢查 CryptoCompare API 的 1 小時、3 天、7 天漲幅（SUI 若無歷史用近似）。漲幅後顯示價格變動 (USD)。若某幣任一時間段遠超，顯示紅色警報。點「刷新」測試。注意：交易風險，請模擬！</p>
    </div>
    <button id="refresh" onclick="updateData()">立即刷新</button>
    <div id="error"></div>
    <div id="alert"></div>
    <div id="prices"></div>
    <div id="lastUpdate"></div>
    <canvas id="returnsChart"></canvas>

    <script>
        const symbols = ['BTC', 'ETH', 'SOL', 'SUI', 'LTC'];
        const API_KEY = '263038e60a28b70ca6275c1cc14b24bdc685299be990279849c5ada3cff3f1f4';
        let chart;

        // 直接 fetch（GitHub Pages 支援）
        async function fetchAPI(endpoint) {
            try {
                const response = await fetch(endpoint);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (e) {
                console.error(`API error: ${e}`);
                return null;
            }
        }

        // 即時價格
        async function getCCPriceData(symbols) {
            const url = `https://min-api.cryptocompare.com/data/pricemulti?fsyms=${symbols.join(',')}&tsyms=USD&api_key=${API_KEY}`;
            return await fetchAPI(url);
        }

        // 歷史數據
        async function getCCHistoricalData(symbol, hours) {
            const url = `https://min-api.cryptocompare.com/data/v2/histohour?fsym=${symbol}&tsym=USD&limit=${hours}&api_key=${API_KEY}`;
            const data = await fetchAPI(url);
            if (data && data.Response === 'Success') {
                return data.Data.Data.map(d => ({ time: d.time * 1000, price: d.close }));
            }
            return null;
        }

        // 計算漲幅
        function calculateReturn(prices, hours) {
            if (!prices || prices.length < hours) return { return: 0, change: 0 };
            const startPrice = prices[prices.length - hours].price;
            const endPrice = prices[prices.length - 1].price;
            return {
                return: (endPrice - startPrice) / startPrice,
                change: endPrice - startPrice
            };
        }

        // 更新數據
        async function updateData() {
            document.getElementById('error').style.display = 'none';
            const marketData = {};
            let errorMsg = '';

            const ccPrices = await getCCPriceData(symbols);
            if (!ccPrices) {
                document.getElementById('error').innerHTML = 'API 失敗，重試。';
                document.getElementById('error').style.display = 'block';
                return;
            }

            for (let symbol of symbols) {
                if (!ccPrices[symbol]) {
                    errorMsg += `無 ${symbol} 價格；`;
                    continue;
                }
                const hist = await getCCHistoricalData(symbol, 168);
                marketData[symbol] = {
                    price: ccPrices[symbol].USD,
                    return_1h: calculateReturn(hist, 1),
                    return_24h: calculateReturn(hist, 24),
                    return_3d: calculateReturn(hist, 72),
                    return_7d: calculateReturn(hist, 168)
                };
                if (!hist) errorMsg += `無 ${symbol} 歷史，用近似；`;
                await new Promise(resolve => setTimeout(resolve, 2000));
            }

            if (errorMsg) {
                document.getElementById('error').innerHTML = `錯誤：${errorMsg}`;
                document.getElementById('error').style.display = 'block';
            }

            // 換倉邏輯（簡化版，用 24h 為例）
            const returns = symbols.map(s => marketData[s]?.return_24h.return || 0);
            const avgReturn = returns.reduce((sum, r) => sum + r, 0) / returns.length;
            const stdReturn = Math.sqrt(returns.reduce((sum, r) => sum + Math.pow(r - avgReturn, 2), 0) / returns.length);
            const threshold = avgReturn + stdReturn;
            const maxReturn = Math.max(...returns);
            let alertMessage = '';
            if (maxReturn > threshold) {
                const outperformerIndex = returns.indexOf(maxReturn);
                const restCoins = symbols.filter((_, i) => i !== outperformerIndex);
                alertMessage = `⚠️ 換倉建議：賣出 ${symbols[outperformerIndex]} (24h 漲幅 ${(maxReturn * 100).toFixed(2)}% > 門檻 ${(threshold * 100).toFixed(2)}%)，換成 ${restCoins.join('/')} 等權重`;
                document.getElementById('alert').style.display = 'block';
            } else {
                alertMessage = '無換倉建議';
                document.getElementById('alert').style.display = 'none';
            }
            document.getElementById('alert').innerHTML = alertMessage;

            // 表格
            const sortedSymbols = symbols.filter(s => marketData[s]).sort((a, b) => (marketData[b].return_24h.return || 0) - (marketData[a].return_24h.return || 0));
            let priceTable = `<table><tr><th>幣種</th><th>價格 (USD)</th><th>24小時漲幅</th></tr>`;
            sortedSymbols.forEach(coin => {
                const r = marketData[coin].return_24h;
                priceTable += `<tr><td>${coin}</td><td>${marketData[coin].price.toFixed(2)}</td><td>${(r.return * 100).toFixed(2)}% (${r.change.toFixed(2)} USD)</td></tr>`;
            });
            priceTable += '</table>';
            document.getElementById('prices').innerHTML = priceTable;

            document.getElementById('lastUpdate').innerHTML = `最後更新: ${new Date().toLocaleString('zh-TW', { timeZone: 'Asia/Tokyo' })}`;
        }

        updateData();
        setInterval(updateData, 10 * 60 * 1000);
    </script>
</body>
</html>